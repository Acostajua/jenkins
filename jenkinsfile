pipeline {
  agent any

  environment {
    IMAGE_NAME = 'miapp:latest'
    REMOTE_HOST = 'usuario@IP_DE_TU_VM'
    REMOTE_PATH = '/home/usuario/app'
  }

  stages {
    stage('Clonar repo') {
      steps {
        git url: 'https://github.com/TU_USUARIO/TU_REPO.git', branch: 'main'
      }
    }

    stage('Construir imagen Docker') {
      steps {
        sh "docker build -t $IMAGE_NAME ."
      }
    }

    stage('Guardar imagen .tar') {
      steps {
        sh "docker save $IMAGE_NAME -o app.tar"
      }
    }

    stage('Copiar a VM') {
      steps {
        sh "scp -o StrictHostKeyChecking=no app.tar $REMOTE_HOST:$REMOTE_PATH/"
        sh "scp -o StrictHostKeyChecking=no docker-compose.yml $REMOTE_HOST:$REMOTE_PATH/"
      }
    }

    stage('Desplegar en la VM') {
      steps {
        sshagent(['id_ssh_vm']) {
          sh "ssh -o StrictHostKeyChecking=no $REMOTE_HOST 'cd $REMOTE_PATH && docker load -i app.tar && docker-compose up -d'"
        }
      }
    }
  }
}
